#!/bin/bash

set -e

QMAIL_HOME="/var/qmail"
VPOPMAIL_HOME="/var/lib/vpopmail"

QMAIL_DOWNLOAD="http://www.qmail.org/netqmail-1.06.tar.gz"
VPOPMAIL_DOWNLOAD="http://sourceforge.net/projects/vpopmail/files/vpopmail-stable/5.4.33/vpopmail-5.4.33.tar.gz/download"


## QMAIL INSTALL BASED ON LWQ ##
cd /usr/src
curl $QMAIL_DOWNLOAD -o netqmail-1.06.tar.gz

tar -zxvf netqmail-1.06.tar.gz
cd netqmail-1.06

# Add users and groups
groupadd nofiles
useradd -g nofiles -d /var/qmail/alias alias
useradd -g nofiles -d /var/qmail qmaild
useradd -g nofiles -d /var/qmail qmaill
useradd -g nofiles -d /var/qmail qmailp
groupadd qmail
useradd -g qmail -d /var/qmail qmailq
useradd -g qmail -d /var/qmail qmailr
useradd -g qmail -d /var/qmail qmails

# Compile and install qmail

make setup check

# Create startup scripts
cat > /var/qmail/rc <<EOF
#!/bin/sh

# Using stdout for logging
# Using control/defaultdelivery from qmail-local to deliver messages by default

exec env - PATH="/var/qmail/bin:$PATH" \
qmail-start "`cat /var/qmail/control/defaultdelivery`"
EOF

mkdir -p /var/qmail/supervise/qmail-send/
mkdir -p /var/qmail/supervise/qmail-smtpd/

cat > /var/qmail/supervise/qmail-send/run <<EOF
#!/bin/sh
exec /var/qmail/rc
EOF

chmod 755 /var/qmail/rc

cat > /var/qmail/supervise/qmail-smtpd/run <<EOF
#!/bin/sh

QMAILDUID=`id -u qmaild`
NOFILESGID=`id -g qmaild`
MAXSMTPD=`cat /var/qmail/control/concurrencyincoming`
LOCAL=`head -1 /var/qmail/control/me`

if [ -z "$QMAILDUID" -o -z "$NOFILESGID" -o -z "$MAXSMTPD" -o -z "$LOCAL" ]; then
    echo QMAILDUID, NOFILESGID, MAXSMTPD, or LOCAL is unset in
    echo /var/qmail/supervise/qmail-smtpd/run
    exit 1
fi

if [ ! -f /var/qmail/control/rcpthosts ]; then
    echo "No /var/qmail/control/rcpthosts!"
    echo "Refusing to start SMTP listener because it'll create an open relay"
    exit 1
fi
EOF

chmod 755 /var/qmail/supervise/qmail-smtpd/run

# configure supervisord to start sidekiq
cat > /etc/supervisor/conf.d/sidekiq.conf <<EOF
[program:qmail-send]
priority=10
directory=${QMAIL_HOME}
environment=HOME=${QMAIL_HOME}
command=${QMAIL_HOME}/rc
user=root
autostart=true
autorestart=true
stdout_logfile=/var/log/qmail/%(program_name)s.log
stderr_logfile=/var/log/qmail/%(program_name)s.log
EOF


# Create log dir
mkdir /var/log/qmail




## VPOPMAIL INSTALL ##
cd /usr/src

curl $VPOPMAIL_DOWNLOAD -o vpopmail.tar.gz
